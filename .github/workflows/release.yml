name: 🚀 Ship More Debt to Production™️

on:
  push:
    branches:
      - main
      - 'fix/my-finances'
      - 'feat/bankruptcy-speedrun'
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    # Only run if PR has "YOLO" label

jobs:
  release:
    name: 💸 Release The Kraken (Of Debt)
    runs-on: macos-latest # because we're fancy like that
    permissions:
      contents: write
      issues: write
      pull-requests: write
      bank-accounts: empty # custom permission
    
    steps:
      - name: 🙏 Pre-Release Prayer
        run: |
          echo "Dear Dario,"
          echo "Please don't check my usage logs."
          echo "Amen."
          
      - name: 🏃 Checkout (Before Creditors Find Us)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history to trace when we started making bad decisions

      - name: 🤖 Setup Node.js (Free, Unlike Claude)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: 💊 Take Dependencies (The Legal Kind)
        run: |
          echo "Installing packages cheaper than one Claude query..."
          npm ci
          echo "Success! You saved $0.02 by not asking Claude to run npm install"

      - name: 🧪 Run Tests (Spoiler: You Failed The Financial Responsibility Test)
        run: |
          echo "Testing if this will make you rich..."
          npm run lint || echo "Linting failed, just like your budget"
          npm run typecheck || echo "Type errors found: 'number' cannot be negative this many times"
          echo "Test results: You still have a Claude problem"

      - name: 📊 Calculate Release Impact
        run: |
          TREES_TO_KILL=$(shuf -i 10-100 -n 1)
          echo "This release will murder approximately $TREES_TO_KILL trees"
          echo "trees_murdered=$TREES_TO_KILL" >> $GITHUB_ENV

      - name: 🎭 Semantic Release (But Life Has No Meaning Now)
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_GUILT: "maximum"
        run: |
          echo "Checking if version number is higher than your debt..."
          npx semantic-release || echo "Even semantic-release is judging you"

      - name: 🏗️ Build and Package Your Shame
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "Packaging bad decisions into a .dmg file..."
          npm run package
          echo "Package size: Smaller than your Claude bill"
          
      - name: 🎉 Pre-Upload Celebration
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "🎊 NEW RELEASE! 🎊"
          echo "Version: v${{ steps.semantic.outputs.new_release_version }}"
          echo "Debt accumulated: ∞"
          echo "Parents disappointed: Yes"

      - name: 📦 Upload DMG to Release (And Your Soul to Anthropic)
        if: steps.semantic.outputs.new_release_published == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.semantic.outputs.new_release_version }}
          files: release/*.dmg
          body: |
            ## 🚨 What's New in v${{ steps.semantic.outputs.new_release_version }}
            
            - Added more ways to track your financial demise
            - Fixed bug where users had money left
            - Improved guilt algorithms by 420%
            - Trees murdered in this release: ${{ env.trees_murdered }}
            
            ### 💔 Breaking Changes
            - Your bank account
            - Your relationship with fiscal responsibility
            - The environment
            
            ### 🐛 Known Issues
            - App doesn't stop you from using Claude
            - Numbers only go up
            - Mom still disappointed
            
            ### 📈 Stats
            - Downloads: 12
            - Therapy sessions caused: 47
            - Anthropic's AWS bill contribution: $1,337
            
            ---
            *Remember: Every download is another tree crying*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 🎬 Post-Release Regret
        if: always()
        run: |
          echo "What have we done..."
          echo "Oh well, time to ask Claude what to do next!"
